// src/features/navigation/OafNavigation.jsx
import { useEffect, useState } from "react";
import { useOaf } from "../oaf/useOaf";

// Direct client calls for diagnostics & window tests
import {
  getUserContext,
  getPageContext,
  oafEvents,
  setSize,
  moveAppToLocation
} from "../oaf/oafClient";

export default function OafNavigation() {
  const [input, setInput] = useState("/purchase-orders");
  const [log, setLog] = useState("Ready.");
  const { oafNavigatePath } = useOaf();

  const append = (line) => setLog((prev) => (prev ? `${prev}\n${line}` : line));

  // Subscribe to OAF host events (some builds emit errors/info via events)
  useEffect(() => {
    const ev = oafEvents && typeof oafEvents === "function" ? oafEvents() : null;
    const handler = (evt) => {
      console.log("[OAF EVENT]", evt?.type || evt, evt);
      append(`[OAF EVENT] ${evt?.type || "message"} ${JSON.stringify(evt)}`);
    };

    if (ev && ev.on) {
      ev.on("error", handler);
      ev.on("oafError", handler);
      ev.on("message", handler);
      ev.on("subscribedAttributeResponse", handler);
    }
    return () => {
      if (ev && ev.off) {
        ev.off("error", handler);
        ev.off("oafError", handler);
        ev.off("message", handler);
        ev.off("subscribedAttributeResponse", handler);
      }
    };
  }, []);

  // --- Diagnostics: prove we are embedded and permitted ---
  const runDiagnostics = async () => {
    setLog("Running diagnostics…");
    try {
      const uc = await getUserContext();
      append("getUserContext:");
      append(JSON.stringify(uc, null, 2));
    } catch (e) {
      append("getUserContext threw:");
      append(String(e?.message || e));
    }

    try {
      const pc = await getPageContext();
      append("getPageContext:");
      append(JSON.stringify(pc, null, 2));
    } catch (e) {
      append("getPageContext threw:");
      append(String(e?.message || e));
    }
  };

  // --- Window management (proves host permissions are honored) ---
  const testResize = async () => {
    try {
      append("Resizing iFrame to 500x360 (host-side) …");
      const r = await setSize(500, 360);
      append(`setSize => ${JSON.stringify(r, null, 2)}`);
    } catch (e) {
      append(`setSize threw => ${String(e?.message || e)}`);
    }
  };

  const testMove = async () => {
    try {
      append("Moving iFrame to top-left (host-side) …");
      const r = await moveAppToLocation(50, 30, false);
      append(`moveToLocation => ${JSON.stringify(r, null, 2)}`);
    } catch (e) {
      append(`moveToLocation threw => ${String(e?.message || e)}`);
    }
  };

  // --- Navigate button action ---
  const handleNavigate = async () => {
    append(`Navigating to: ${input}`);
    const resp = await oafNavigatePath(input);
    append("navigateToPath response:");
    append(JSON.stringify(resp, null, 2));
  };

  // Quick test buttons with common core routes
  const quickPaths = [
    "/purchase-orders",
    "/suppliers/new",
    "/invoices?status=pending",
    "/purchase_orders",        // underscore variant, sometimes needed
    "/requisition_headers"     // your original test
  ];

  return (
    <div style={styles.card}>
      <h3 style={styles.title}>OAF Navigation</h3>

      <div style={styles.row}>
        <input
          style={styles.input}
          placeholder="Enter Coupa path (e.g., /purchase-orders)"
          value={input}
          onChange={(e) => setInput(e.target.value)}
        />
        <button style={styles.button} onClick={handleNavigate}>
          Navigate to Path
        </button>
      </div>

      <div style={{ marginTop: 8 }}>
        <strong>Quick tests:</strong>
        <div style={styles.testRow}>
          {quickPaths.map((p) => (
            <button
              key={p}
              style={styles.testBtn}
              onClick={() => {
                setInput(p);
                handleNavigate();
              }}
            >
              {p}
            </button>
          ))}
        </div>
      </div>

      <div style={{ marginTop: 8, display: "flex", gap: 8 }}>
        <button style={styles.buttonGhost} onClick={runDiagnostics}>
          Run Diagnostics
        </button>
        <button style={styles.buttonGhost} onClick={testResize}>
          Test Resize
        </button>
        <button style={styles.buttonGhost} onClick={testMove}>
          Test Move
        </button>
      </div>

      <textarea
        readOnly
        value={log}
        style={styles.log}
        aria-label="Diagnostics log"
      />
    </div>
  );
}

const styles = {
  card: {
    padding: 16,
    background: "#fff",
    border: "1px solid #e6e8eb",
    borderRadius: 8,
  },
  title: { margin: 0, marginBottom: 12 },
  row: { display: "flex", gap: 8, alignItems: "center" },
  input: {
    flex: 1,
    padding: "8px 10px",
    border: "1px solid #c9cdd2",
    borderRadius: 6,
  },
  button: {
    padding: "8px 12px",
    background: "#0d6efd",
    color: "#fff",
    border: "none",
    borderRadius: 6,
    cursor: "pointer",
  },
  buttonGhost: {
    padding: "8px 12px",
    background: "transparent",
    color: "#0d6efd",
    border: "1px solid #0d6efd",
    borderRadius: 6,
    cursor: "pointer",
  },
  testRow: { display: "flex", flexWrap: "wrap", gap: 8, marginTop: 6 },
  testBtn: {
    padding: "6px 10px",
    background: "#f3f4f6",
    border: "1px solid #d1d5db",
    borderRadius: 6,
    cursor: "pointer",
  },
  log: {
    width: "100%",
    height: 220,
    marginTop: 12,
    padding: 10,
    border: "1px solid #d1d5db",
    borderRadius: 6,
    fontFamily: "monospace",
    fontSize: 12,
    whiteSpace: "pre",
  },
};